@using FinalProjectMvc.ViewModels.Admin.Reservation
@model ReservationCreateVM

<section id="reservation-section">
    <div class="reservation-container">
        <div class="header">
            <h1 class="main-title">CAFFE LUNA</h1>
            <p class="subtitle">Make Your Reservation</p>
            <div class="schedule-info">
                <p><strong>Opening Hours:</strong></p>
                <p>Monday - Friday: 09:00 - 22:00</p>
                <p>Weekend: 09:00 - 23:30</p>
            </div>
        </div>

        <div class="main-content">
            <div class="form-section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Reservation Form</h2>
                    </div>
                    <div class="card-content">
                        <form id="reservationForm" method="post" asp-controller="Reservation" asp-action="Create">
                            <div class="form-group">
                                <label for="name" class="label">Full Name *</label>
                                <input type="text" id="name" class="input" placeholder="Enter your name"
                                       required minlength="2">
                                <span class="error-msg" id="nameError"></span>
                            </div>

                            <div class="form-group">
                                <label for="email" class="label">Email Address *</label>
                                <input type="email" id="email" class="input" placeholder="Enter your email"
                                       required>
                                <span class="error-msg" id="emailError"></span>
                            </div>

                            <div class="form-group">
                                <label for="phone" class="label"> Phone Number * (for SMS notifications)</label>
                                <input type="tel" id="phone" class="input" placeholder="+994 XX XXX XX XX"
                                       required>
                                <span class="error-msg" id="phoneError"></span>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="date" class="label"> Date *</label>
                                    <input type="date" id="date" class="input" required>
                                    <span class="error-msg" id="dateError"></span>
                                </div>
                                <div class="form-group">
                                    <label for="time" class="label"> Time *</label>
                                    <input type="time" id="time" class="input" required>
                                    <span class="error-msg" id="timeError"></span>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="guests" class="label">Number of Guests * (Max 15)</label>
                                <input type="number" id="guests" class="input" min="1" max="15"
                                       placeholder="How many people?" required onchange="filterTablesByGuestCount()">
                                <span class="error-msg" id="guestsError"></span>
                            </div>

                            <div class="form-group">
                                <label for="tableSelect" class="label">Select Table *</label>
                                <select id="tableSelect" class="input" required>
                                    <option value="">Select date, time and guests first</option>
                                    @if (Model.Tables != null)
                                    {
                                        foreach (var table in Model.Tables)
                                        {
                                            <option value="@table.Id" data-capacity="@table.Capacity">
                                                Table @table.Number - (@table.Location) Capacity @table.Capacity
                                            </option>
                                        }
                                    }
                                </select>
                                <span class="error-msg" id="tableError"></span>
                            </div>
                            <div class="form-group">
                                <label for="notes" class="label">Additional Notes</label>
                                <textarea id="notes" class="textarea"
                                          placeholder="Any special requests..."></textarea>
                            </div>

                            <button type="button" id="toggleMenu" class="btn btn-primary btn-full" disabled>
                                Select Menu Items (Complete form first)
                            </button>

                            <div id="cartDisplay" class="cart-display" style="display: none;">
                                <h3 class="cart-title">Selected Items</h3>
                                <div id="cartItems" class="cart-items"></div>
                                <div class="cart-total">
                                    <div class="total-row">
                                        <span>Total:</span>
                                        <span id="totalPrice">$0.00</span>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="label">Payment Method *</label>
                                <div class="radio-group">
                                    <div class="radio-item" style="color: white;">
                                        <input type="radio" id="online" name="payment" value="online" checked
                                               required>
                                        <label for="online">Online Payment</label>
                                    </div>

                                </div>
                            </div>

                            <div id="paymentSection" class="payment-section" style="display: none;">
                                <div class="card payment-card">
                                    <div class="card-header">
                                        <h3 class="card-title"> Payment Details</h3>
                                    </div>
                                    <div class="card-content">
                                        <div class="form-group">
                                            <label for="cardNumber" class="label">Card Number *</label>
                                            <input type="text" id="cardNumber" class="input"
                                                   placeholder="1234 5678 9012 3456" maxlength="19" required>
                                            <span class="error-msg" id="cardNumberError"></span>
                                        </div>

                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="expiryDate" class="label">Expiry Date *</label>
                                                <input type="text" id="expiryDate" class="input"
                                                       placeholder="MM/YY" maxlength="5" required>
                                                <span class="error-msg" id="expiryError"></span>
                                            </div>
                                            <div class="form-group">
                                                <label for="cvv" class="label">CVV *</label>
                                                <input type="text" id="cvv" class="input" placeholder="123"
                                                       maxlength="4" required>
                                                <span class="error-msg" id="cvvError"></span>
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label for="cardName" class="label">Cardholder Name *</label>
                                            <input type="text" id="cardName" class="input"
                                                   placeholder="Name on card" required>
                                            <span class="error-msg" id="cardNameError"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button type="submit" id="submitBtn" class="btn btn-primary btn-full" disabled>
                                Complete Reservation
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="menu-section" id="menuSection">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Menu</h2>
                        <div class="category-filters">
                            <button class="filter-btn active" onclick="filterCategory('all')">
                                All Categories
                            </button>

                            @if (Model?.Categories != null)
                            {
                                foreach (var category in Model.Categories)
                                {
                                    var slug = category.Name.ToLower().Replace(" ", "-");
                                    <button class="filter-btn" onclick="filterCategory('@slug')">
                                        @category.Name
                                    </button>
                                }
                            }
                            else
                            {
                                <p>No categories available.</p>
                            }

                        </div>

                    </div>
                    <div class="card-content">
                        <div class="menu-items">

                            @foreach (var product in Model.Products)
                            {
                                <div class="menu-item" data-category="@product.CategorySlug">
                                    <div class="menu-item-header">
                                        <h3 class="menu-item-name">@product.Name</h3>
                                        <span class="menu-item-price" id="price-@product.Id">$@product.Price</span>
                                    </div>
                                    <p class="menu-item-description">@product.Ingredients</p>

                                    @if (product.CategoryTypeId == 1 && product.Sizes?.Any() == true)
                                    {
                                        <div class="size-options">
                                            @{
                                                int index = 0;
                                            }

                                            @foreach (var size in product.Sizes)
                                            {
                                                var addedAmount = 2 * index;
                                                var calculatedPrice = product.Price + addedAmount;

                                                <button class="size-btn @(index == 0 ? "active" : "")"
                                                        onclick="selectSize(this, '@product.Id', @product.Price, @addedAmount)">
                                                    @size.Name - $@calculatedPrice
                                                </button>

                                                index++;
                                            }
                                        </div>
                                    }

                                    <button class="add-to-cart-btn"
                                            id="add-btn-@product.Id"
                                            onclick="addToCart('@product.Name', @product.Price, '@product.Id')">
                                        + Add to Cart
                                    </button>
                                </div>
                            }

                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div id="successModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2> Reservation Confirmed!</h2>
                </div>
                <div class="modal-body">
                    <div id="confirmationDetails"></div>
                    <div class="qr-section">
                        <h3>Your QR Code</h3>
                        <p>Show this QR code when you arrive:</p>
                        <canvas id="qrCode"></canvas>
                        <p class="qr-note">Screenshot or save this QR code</p>
                    </div>
                    <div class="cancellation-info">
                        <h3> Cancellation Policy</h3>
                        <p>
                            If you cannot attend, please notify us at least 2 hours before your reservation time.
                        </p>
                        <button id="cancelReservation" class="btn btn-danger"
                                onclick="cancelReservation()">
                            Cancel This Reservation
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button onclick="closeModal()" class="btn btn-primary">Close</button>
                </div>
            </div>
        </div>

        <div id="loadingModal" class="modal" style="display: none;">
            <div class="modal-content loading-content">
                <div class="loading-spinner"></div>
                <h3>Processing your reservation...</h3>
                <p>Please wait while we confirm your booking and send confirmation email.</p>
            </div>
        </div>
    </div>
</section>



<script>
    function filterTablesByGuestCount() {
        var guestCount = parseInt(document.getElementById("guests").value);
        var tableSelect = document.getElementById("tableSelect");
        var options = tableSelect.options;

        for (var i = 0; i < options.length; i++) {
            var option = options[i];
            var capacity = parseInt(option.getAttribute("data-capacity"));

        
            if (!capacity) continue;

            if (capacity === guestCount) {
                option.style.display = "block";
            } else {
                option.style.display = "none";
            }
        }

        tableSelect.value = "";
    }
</script>
